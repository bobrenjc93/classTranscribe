[{"text":"now my code didn't attempt to do any error checking, so i'm just trying to string cat straight into this address which would be -1","width":640},{"text":"and so i will probably get a segfault ","width":192},{"text":"in my code ","width":192},{"text":"um, i didn't talk about map file and in fact map file is the default and in fact you can it's not necessary to specify","width":704},{"text":"but you'll notice that all these things are bitwise or-ed ","width":256},{"text":"so we build up a single integer that represents all of these flags","width":256},{"text":"so, we've got this one we've shared","width":128},{"text":"this one which is map private","width":128},{"text":"and here's the great thing is that when we specify map private it means to this particular process","width":448},{"text":"so we can read justin's lyrics if we want","width":384},{"text":"but fortunately we think they're a bit of a cow, so we can do copy on write","width":512},{"text":"so we can actually overwrite to our heart's content all of his lyrics if we wish to","width":320},{"text":"unfortunately, we can't change what comes what comes out of his mouth","width":384},{"text":"he gets to keep his own copy of his lyrics file","width":192},{"text":"we're only going to change what's inside ram","width":128},{"text":"what's inisde our memory","width":128},{"text":"so this is allowed, this is okay even though we said that the file itself is read only","width":448},{"text":"and we want to write into it ","width":128},{"text":"we're doing that because memory is private","width":256},{"text":"and so we get to store our own copy in memory","width":320},{"text":"okay um ","width":384},{"text":"once you finish changing things","width":576},{"text":"then it's important to call m-unmap ","width":320},{"text":"to release these resources","width":192},{"text":"right to say 'okay i've finished with this particular mapping'","width":1024},{"text":"at which point","width":64},{"text":"the system may get around to writing it out to disk if you set it up that way","width":256},{"text":"but it doesn't have to immediately and in fact for performance there's no reason  why it might do it between now and some point in the distant distant future ","width":640},{"text":"so there's one other useful thing i'm not gonna test this but hey if you ever use this mechanism ","width":256},{"text":"if you want to force your changes to be sent back to the file system ","width":384},{"text":"call msync","width":64},{"text":"it's like nsync, but more musical i'm sorry terrible joke, ","width":640},{"text":"okay, they're a boy band, they were allegedly popular ","width":576},{"text":"i probably misspelled it ","width":256},{"text":"anyways, so!","width":64},{"text":"yes, do this but realize if you call msync to many times then you're going to have slow performance because then you're waiting for your pages of memory to be written back to disk ","width":832},{"text":"okay, so ","width":128},{"text":"we know enough now to start playing with mmap ","width":256},{"text":"remember if it doesn't work actually find out what the rror message was and think about your options","width":384},{"text":"what kind of memory mapping do i want to use","width":192},{"text":"so let's use this ","width":128},{"text":"and this hints now for how we're going to create our first tim berners-lee kind of web server","width":512},{"text":"let's say we want to serve a file back to a client ","width":320},{"text":"we actually want to send some bytes","width":128},{"text":"we've already made our socket code","width":384},{"text":"and we've already set up a file descriptor","width":256},{"text":"so somewhere previously i've done something like ","width":128},{"text":"okay let's do fd-open on something i've got back from my accept call something like that ","width":768},{"text":"so now i can receiving and sending bytes using the c library to the client","width":448},{"text":"and now i want to send the file ","width":192},{"text":"okay, so the http protocol says you should write a few lines of text at the beginning like the MIME type, like the content length","width":576},{"text":"so yeah pretend i've written those lines","width":192},{"text":"now i just want to send the bytes","width":128},{"text":"here's how we can do it","width":128},{"text":"first of all","width":64},{"text":"remember stat? let's use stat to find out the actual size of our file ","width":192},{"text":"then i'm actually going to open it so i just need my read-only flag here ","width":576},{"text":"that's easy enough we've got that up there","width":128},{"text":"and then i want to map that into memory","width":320},{"text":"okay","width":64},{"text":"this is where you come in","width":192},{"text":"what would you write","width":192},{"text":"have a look up here to see if you can figure out the options ","width":64},{"text":"what options do you need? because once you've got that pointer, we'll check if it's not equal to -1","width":448},{"text":"we can just call fwrite to send those bytes in memory!","width":256},{"text":"look here's the bytes i want to send, send me 1*this number of bytes","width":384},{"text":"bam we're done!","width":128},{"text":"we have the WWW thank you very much i am tim berners-lee","width":320},{"text":"or you've got missing just this line, so this is the one line that's missing between us and finishing our WWW web server","width":704},{"text":"what are you going to write in this line? take 2 minutes to see if you can write this line ","width":192},{"text":"you can write it down here if you want if you're out of space","width":128},{"text":"what options do you need for mmap? ","width":576},{"text":"okay, so what do we need? right","width":5888},{"text":"i'm not going to spend any special options today, we need to pass in how many bytes we actually want to map from the file","width":704},{"text":"we only want to read through it ","width":192}]